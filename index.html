<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Mileage</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#007bff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="My Mileage">
<link rel="apple-touch-icon" href="icon.png">

<style>
body { font-family: Arial; background:#f4f6f8; padding:10px; }
.container { background:#fff; padding:15px; border-radius:8px; max-width:480px; margin:auto; }
h2,h3 { text-align:center; }
label { font-weight:bold; margin-top:10px; display:block; }

input, select, textarea, button {
  width:100%; padding:9px; margin-top:5px; font-size:15px;
}
input[readonly] {
  background:#eef3ff;
  font-weight:bold;
  text-align:center;
}

.row { display:flex; gap:6px; }
.row input, .row select, .row button { flex:1; }

button {
  background:#007bff; color:#fff; border:none;
  border-radius:5px; margin-top:12px;
}
button:disabled { background:#999; }

table {
  width:100%; font-size:13px; margin-top:10px;
  border-collapse:collapse;
}
th, td {
  border:1px solid #ccc; padding:5px; text-align:center;
}

.alert {
  background:#ffe6e6; padding:8px; border-radius:5px;
  margin-bottom:10px; color:#900; text-align:center;
}
</style>
</head>

<body>

<div class="container">
<h2>My Mileage</h2>

<div id="missedAlert" class="alert" style="display:none;">
⚠️ Yesterday's visit was not ended. Please complete it.
</div>

<!-- Visit details -->
<label>Visit Details</label>
<div class="row">
  <input type="date" id="visitDate" readonly>
  <select id="visitType">
    <option>Official</option>
    <option>Personal</option>
  </select>
</div>

<!-- Odometer -->
<label>Odometer Readings</label>
<div class="row">
  <input type="number" id="startOdo" placeholder="Start Odo">
  <input type="number" id="endOdo" placeholder="End Odo">
</div>

<!-- TOTAL RUNNING KMS (SINGLE ROW) -->
<label>Total Running KMs</label>
<div class="row">
  <input type="text" id="tripKm" readonly placeholder="Trip KM">
  <input type="text" id="dayKm" readonly placeholder="Day KM">
  <input type="text" id="monthKm" readonly placeholder="Month KM">
</div>

<label>Day Plan / Visits *</label>
<textarea id="dayPlan" rows="2"></textarea>

<button id="actionBtn" onclick="handleVisit()">Start Visit</button>

<hr>

<h3>Daily Summary</h3>
<table id="dataTable">
<tr><th>Date</th><th>Type</th><th>KM</th><th>Map</th></tr>
</table>

<hr>

<h3>Export CSV / Excel</h3>
<div class="row">
  <input type="date" id="fromDate">
  <input type="date" id="toDate">
  <button onclick="exportCSV()">Export</button>
</div>

</div>

<script>
/* ================= DATA ================= */
let visits = JSON.parse(localStorage.getItem("visits")) || [];
const today = new Date().toISOString().split("T")[0];
visitDate.value = today;

let todayVisit = visits.find(v => v.date === today) || null;

/* ================= GPS (silent) ================= */
let gpsLat="", gpsLng="";
function captureGPS() {
  if (!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(
    p => {
      gpsLat = p.coords.latitude.toFixed(6);
      gpsLng = p.coords.longitude.toFixed(6);
    }
  );
}
setTimeout(captureGPS, 1000);

/* ================= MISSED VISIT ALERT ================= */
let y = new Date(); y.setDate(y.getDate()-1);
let yDate = y.toISOString().split("T")[0];
if (visits.find(v => v.date===yDate && !v.endOdo)) {
  document.getElementById("missedAlert").style.display="block";
}

/* ================= INIT ================= */
startOdo.value = localStorage.getItem("lastEndOdo") || "";

if (todayVisit) {
  startOdo.value = todayVisit.startOdo;
  endOdo.value = todayVisit.endOdo || "";
  dayPlan.value = todayVisit.dayPlan;
}

updateButton();
updateTable();
updateRunningKms();

/* ================= BUTTON STATE ================= */
function updateButton() {
  if (!todayVisit) actionBtn.innerText="Start Visit";
  else if (!todayVisit.endOdo) actionBtn.innerText="End Visit";
  else { actionBtn.innerText="Visit Completed"; actionBtn.disabled=true; }
}

/* ================= MAIN LOGIC ================= */
function handleVisit() {

  if (!dayPlan.value.trim()) {
    alert("Day Plan / Visits is mandatory"); return;
  }

  if (!gpsLat || !gpsLng) {
    alert("Allow GPS location"); captureGPS(); return;
  }

  /* START VISIT */
  if (!todayVisit) {
    if (!startOdo.value) { alert("Enter Start Odometer"); return; }

    todayVisit = {
      date: today,
      visitType: visitType.value,
      dayPlan: dayPlan.value,
      startOdo: Number(startOdo.value),
      startTime: new Date().toLocaleTimeString(),
      startLat: gpsLat,
      startLng: gpsLng,
      endOdo:"",
      endTime:"",
      endLat:"",
      endLng:"",
      totalKm:""
    };

    visits.push(todayVisit);
    localStorage.setItem("visits", JSON.stringify(visits));
    alert("Start Visit saved");
  }

  /* END VISIT */
  else if (!todayVisit.endOdo) {
    if (!endOdo.value) { alert("Enter End Odometer"); return; }
    if (Number(endOdo.value) <= todayVisit.startOdo) {
      alert("End Odometer must be greater"); return;
    }

    todayVisit.endOdo = Number(endOdo.value);
    todayVisit.endTime = new Date().toLocaleTimeString();
    todayVisit.endLat = gpsLat;
    todayVisit.endLng = gpsLng;
    todayVisit.totalKm = todayVisit.endOdo - todayVisit.startOdo;

    localStorage.setItem("lastEndOdo", todayVisit.endOdo);
    localStorage.setItem("visits", JSON.stringify(visits));
    alert("End Visit saved");
  }

  updateButton();
  updateTable();
  updateRunningKms();
}

/* ================= TABLE ================= */
function updateTable() {
  let t = document.getElementById("dataTable");
  t.innerHTML = `<tr><th>Date</th><th>Type</th><th>KM</th><th>Map</th></tr>`;
  visits.forEach(v=>{
    let map = (v.startLat && v.endLat)
      ? `<a href="https://www.google.com/maps/dir/${v.startLat},${v.startLng}/${v.endLat},${v.endLng}" target="_blank">Route</a>`
      : "-";
    t.innerHTML += `
      <tr>
        <td>${v.date}</td>
        <td>${v.visitType}</td>
        <td>${v.totalKm || "-"}</td>
        <td>${map}</td>
      </tr>`;
  });
}

/* ================= TOTAL RUNNING KMS ================= */
function updateRunningKms() {
  let trip = todayVisit && todayVisit.totalKm ? todayVisit.totalKm : 0;
  let day = 0, month = 0;
  let m = today.slice(0,7);

  visits.forEach(v=>{
    if (v.date === today && v.totalKm) day += Number(v.totalKm);
    if (v.date.startsWith(m) && v.totalKm) month += Number(v.totalKm);
  });

  tripKm.value = `Trip: ${trip} KM`;
  dayKm.value = `Day: ${day} KM`;
  monthKm.value = `Month: ${month} KM`;
}

/* ================= EXPORT ================= */
function exportCSV() {
  if (!fromDate.value || !toDate.value) {
    alert("Select date range"); return;
  }
  let csv = "Date,Type,StartOdo,EndOdo,KM,StartTime,EndTime,DayPlan\n";
  visits.filter(v=>v.date>=fromDate.value && v.date<=toDate.value)
    .forEach(v=>{
      csv += `${v.date},${v.visitType},${v.startOdo},${v.endOdo},${v.totalKm},${v.startTime},${v.endTime},"${v.dayPlan}"\n`;
    });
  let blob = new Blob([csv],{type:"text/csv"});
  let a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="MyMileage.csv";
  a.click();
}

/* ================= SERVICE WORKER ================= */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
